<source>
  @type tail
  path /var/log/nginx/access.log
  pos_file /var/log/td-agent/nginx.access.pos
  tag nginx.access
  <parse>
    @type nginx
  </parse>
</source>

<source>
  @type tail
  path /var/log/nginx/error.log
  pos_file /var/log/td-agent/nginx.error.pos
  tag nginx.error
  <parse>
    @type regexp
    expression /^(?<time>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<pid>\d+).*?: (?<message>.*)$/
    time_format %Y/%m/%d %H:%M:%S
  </parse>
</source>

<filter nginx.*>
  @type grep
  <exclude>
    key remote_addr
    pattern_file /etc/td-agent/denylist.txt
  </exclude>
</filter>

<match nginx.*>
  @type copy
  <store>
    @type file
    path /var/log/td-agent/denylist_audit
    append true
    <buffer>
      timekey 1d
      timekey_use_utc true
      timekey_wait 10m
    </buffer>
    <format>
      @type json
    </format>
  </store>
</match>